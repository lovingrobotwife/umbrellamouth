#! /home/orange/pyenv/bin/python -B

from datetime import datetime, timedelta, timezone

from fsrs import Optimizer, ReviewLog, Rating, Card

from umbrellamouth import *

@with_cursor
def get_fsrs(cursor=None):
    cursor.execute('''
        SELECT entry FROM umbrellamouth 
        WHERE attribute = 'scheduler'
        AND value = '"fsrs"'
    ''')
    return [entry[0] for entry in cursor.fetchall()] 

@with_cursor
def get_review_logs(cursor=None):
    review_logs = []

    for entry, attrs in parse(get_fsrs(cursor=cursor), cursor=cursor):
        review_log = attrs.get('review_log', [])

        for timestamp, label in review_log:
            rating = Rating.Good if label else Rating.Again # 0 is again, 1 is good
            review_datetime = datetime.fromtimestamp(timestamp, tz=timezone.utc)
            review_logs.append(ReviewLog(card_id=str(entry), rating=rating, review_datetime=review_datetime, review_duration=None))

    return review_logs

@with_cursor
def main(cursor=None):
    review_logs = get_review_logs(cursor=cursor) 
    optimizer = Optimizer(review_logs)
    parameters = optimizer.compute_optimal_parameters()
    print(f'{len(review_logs)} reviews')
    print(parameters) 

if __name__ == '__main__':
    main()
