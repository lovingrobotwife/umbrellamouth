#! /home/orange/pyenv/bin/python -B

import sys
import random
import argparse
import subprocess
from datetime import datetime, timedelta, timezone

from fsrs import Scheduler, Rating, Card

from umbrellamouth import *

# these are my parameters
PARAMETERS = [0.2172, 1.1771, 3.1399724739905577, 16.1507, 6.990029991049342, 0.6737209734529048, 1.9778112524529623, 0.12473790288480519, 1.6456208300328843, 0.22796849998602758, 1.1371402103615733, 1.7336650984332, 0.22647829486238844, 0.19552846881257227, 2.184353775919947, 0.2191, 3.0004, 0.6410731048408812, 0.45307672340864935, 0.07371176186846487, 0.1]
MAXIMUM_INTERVAL = 36500
DESIRED_RETENTION = 0.9 # DR is currently randomized between 0.8 and 0.95 (

PASS_RATINGS = ('1', 'pass', 'good')
FAIL_RATINGS = ('0', 'fail', 'again')
RATINGS = PASS_RATINGS + FAIL_RATINGS

def due_(review_log):
    desired_retention = random.uniform(0.8, 0.95)

    scheduler = Scheduler(
        parameters=PARAMETERS,
        desired_retention=desired_retention,
        learning_steps=(),
        relearning_steps=(),
        maximum_interval=MAXIMUM_INTERVAL,
        enable_fuzzing=False
    )
    
    card = Card()

    for timestamp, rating in review_log:
        rating = Rating.Good if rating else Rating.Again
        review_datetime = datetime.fromtimestamp(timestamp, tz=timezone.utc)
        card, _ = scheduler.review_card(card, rating, review_datetime=review_datetime)

    interval = interval_(card.due.astimezone().replace(tzinfo=None))
    #interval = gauss_fuzz(interval, ratio=0.1) # TODO is this necessary when DR is randomized?
                                               # it probably doesn't matter that much, but maybe...

    return datetime.now() + timedelta(days=interval)

@with_cursor
def main(cursor=None):
    parser = argparse.ArgumentParser()
    parser.add_argument('rating', nargs='?', choices=RATINGS)
    parser.add_argument('--ask', action='store_true')
    args = parser.parse_args()
    
    stdin = parse_stdin()

    # prompt for input if not provided
    if args.rating is None:
        if not args.ask:
            print('provide rating or --ask', file=sys.stderr)
            sys.exit(3) # 3 is for call_scheduler function

        output = subprocess.run(
            ['rofi', '-dmenu', '-no-custom', '-p', 'rating'],
            input='1 again\n3 good', 
            text=True, 
            capture_output=True,
        ).stdout.strip()

        if not output: # pressed esc usually
            sys.exit()

        args.rating = output.split()[1].strip()

    # validate input
    if args.rating in PASS_RATINGS: args.rating = 1
    elif args.rating in FAIL_RATINGS: args.rating = 0
    else: raise Exception('invalid rating')

    # review
    for entry, attrs in parse(stdin, cursor=cursor):
        review_log = attrs.get('review_log', [])
        review_log = remove_same_day_repetition(review_log)
        review_log.append([int(datetime.now().timestamp()), args.rating]) 
        
        due = due_(review_log)
        interval = interval_(due)

        attrs['due'] = int(due.timestamp())
        attrs['interval'] = interval 
        attrs['review_log'] = review_log

        save_attrs(entry, attrs, cursor=cursor)

if __name__ == '__main__':
    main()
